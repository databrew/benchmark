---
params:
  rd: !r data.frame(a = 1:3) # plotting data
  ip: ! list(a = 1:5) # input list
title: "Benchmark report"
fig_height: 2.6
fig_width: 4
output: pdf_document
---

```{r setup, include=FALSE}
# output: 
#   pdf_document:
#     latex_engine: xelatex
#     template: pdf/layout.tex
#     includes:
#       in_header: pdf/preamble.sty
library(knitr)# Basic knitr options
opts_chunk$set(comment = NA, 
               echo = FALSE, 
               warning = FALSE, 
               message = FALSE, 
               error = TRUE, 
               cache = F,
               fig.height = 6)
knit_engines$set(asis = function(options) {
  if (options$echo && options$eval) knit_child(text = options$code)
})

# Specify paramaters
for (i in 1:length(params)){
  assign(names(params)[i],
         params[[i]],
         env = .GlobalEnv)
}


library(radarchart)
source('../global.R', chdir = TRUE)

# Define function for getting all qualy text associated with any tab name
make_qualy_table <- function(data, tn = 'organization_and_governance'){
  # Get the qualitative comments
  sub_data <- data %>%
    filter(grepl(tn, key)) %>%
    filter(grepl('qualy', key)) %>%
    dplyr::rename(`Qualitative assessment` = value)
  # Clean up the keys
  sub_data <-
    sub_data %>%
    mutate(key = gsub('_qualy', '', key)) %>%
    mutate(key = convert_capitalization(simple_cap(gsub('_', ' ', key)))) %>%
    dplyr::rename(Dimension = key)
  return(kable(sub_data, type = 'latex'))
}
```


## Radar charts

```{r}
# Get raw data
ip <- reactiveValuesToList(ip)
ip <- unlist(ip)
df <- data.frame(key = names(ip),
                 value = ip)
df$key <- as.character(df$key)

chunks <- rep(NA, length(tab_names))
for (i in 1:length(tab_names)){
  tab_name <- tab_names[i]
  title <- simple_cap(gsub('_', ' ', tab_name))
  title <- convert_capitalization(title)
  chunks[i] <- paste0('## ', title, '\n\n### Quantitative assessment\n\n```{r, fig.height = 6, fig.width = 7}\n',
         'make_radar_chart(rd, tn = "', tab_name, '", label_size = 14, height = 250, gg = TRUE)\n```\n\n',
         '### Qualitative assessment\n\n```{r, results = "asis"}\n',
         'make_qualy_table(tn = "', tab_name, '",data = df)\n```\n\n')
}
```


```{r}
# Write our order / child-calls to a doc
file_connection <- file('children.Rmd')
writeLines(paste0('---\noutput: pdf_document\n---\n\n', 
                  chunks), 
           file_connection)
close(file_connection)
```

```{r child='children.Rmd', echo = FALSE}
# Now, we simply include "children.Rmd" to construct our doc
# (ie, children is the child doc, and each section is a grandchild)
```

```{r, results='hide'}
# Having already called the auto-generated children.Rmd, we can delete it
file.remove('children.Rmd')
```

